# Agile Plan: Critical UDT Validation Bug Fixes
**Date**: 2025-08-26
**Plan ID**: 20250826_092215
**Objective**: Address two critical validation gaps in the Pine Script parser concerning User-Defined Types (UDTs) to enhance service reliability for institutional-grade development.
**Source file**: /home/rdelgado/Development/mcp-server-pinescript/index.ts 

## 1. Overview & Strategy

This plan outlines a focused, two-phased approach to resolve critical bugs identified in reports `MCP_PINESCRIPT_UDT_HISTORY_ERROR`, `MCP_PINESCRIPT_RUNTIME_NA_OBJECT_BUG_REPORT`, and `MCP_TRIAGE_REPORT_UDT_NA_ERRORS`.

Our methodology will be **Test-Driven Development (TDD)**, facilitated by an **Agile Coach** in a **Pair Programming** format. We will tackle one bug at a time to ensure focus, manage complexity, and deliver incremental value. This approach respects the constraints of context, token usage, and session time.

## 2. The Agile Team

-   **Context Manager (`Fletcher`)**: Responsible for managing the team's context and ensuring the team is on track to deliver the plan.
-   **Pine Script Developer (`Paula`)**: Lead developer responsible for analyzing and modifying the core parsing and validation logic.
-   **Pinescript v6 Compliance Specialist (`Valencia`)**: Specialist responsible for enuring Pine Script v6 adherence to the specification.
-   **Agile Coach (`Herbie`)**: Facilitator for the pair programming sessions, ensuring the team adheres to the plan, stays focused, and effectively collaborates.

## 3. Phase 1: UDT History-Referencing Syntax Error (Compile-Time)

**Goal**: Implement validation to detect incorrect history-referencing syntax on UDT fields (e.g., `myUdt.field[1]`).

**Fixture**: `udt_history_test.pine`

| Step | Task | Lead Agent | Supporting Agent | Description |
| :--- | :--- | :--- | :--- | :--- |
| **1.1** | **Create Failing Test** | `Paula` | `Valencia` | Integrate `udt_history_test.pine` into a new, failing `vitest` test case that asserts the expected compilation error. This establishes our TDD baseline. |
| **1.2** | **Analyze & Plan Fix (Pair)** | `Valencia` | `Paula` | In a pair session, analyze the parser's AST generation for member access. Identify where to inject the new validation rule to distinguish between `(obj[x]).field` and `obj.field[x]` patterns for UDTs. |
| **1.3** | **Implement Validation (Pair)** | `Valencia` | `Paula` | Modify the parser to recognize the invalid syntax pattern and generate the appropriate error, as specified in the bug report. |
| **1.4** | **Verify & Refactor** | `Valencia` | `Paula` | Run the test suite. Confirm the new test passes and that no existing tests have regressed. Refactor the implementation for clarity and performance. |

## 4. Phase 2: `na` UDT Object Field Access (Run-Time)

**Goal**: Implement validation to detect attempts to access fields on a UDT variable that is `na`.

**Fixtures**: `udt_na_test.pine`, `udt_na_test2.pine`

| Step | Task | Lead Agent | Supporting Agent | Description |
| :--- | :--- | :--- | :--- | :--- |
| **2.1** | **Create Failing Tests** | `Paula` | `Valencia` | Integrate the `na` test fixtures into one or more new, failing `vitest` test cases. These tests will assert that accessing a field on an `na` UDT object produces a critical error. |
| **2.2** | **Analyze & Plan Fix (Pair)** | `Valencia` | `Paula` | This is more complex than a simple syntax check. The team will analyze the feasibility of tracking the "na-state" of UDT variables. The plan is to flag any direct field access on a variable explicitly initialized with `var MyType myVar = na`. |
| **2.3** | **Implement Validation (Pair)** | `Valencia` | `Paula` | Implement the logic to identify `na` UDT declarations and flag any subsequent field access on that variable as a high-severity error. This may require enhancing the parser's symbol table to track variable state. |
| **2.4** | **Verify & Refactor** | `Valencia` | `Paula` | Run the full test suite to ensure the new tests pass without regressions. Pay special attention to performance, as state-tracking can be intensive. |

## 5. General Considerations

-   **Atomic Commits**: Each successfully completed phase will be followed by a clear, descriptive commit.
-   **Session Management**: The Agile Coach will manage session scope to ensure each phase can be completed within a reasonable time, respecting token limits.
-   **Documentation**: Any changes to the parser's capabilities will be noted for future documentation updates.
