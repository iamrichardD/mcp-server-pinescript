#!/bin/sh
#
# Pre-commit hook for mcp-server-pinescript
# 
# This hook performs the following operations in sequence:
# 1. TypeScript compilation (npm run build)
# 2. Test suite execution (npm test)  
# 3. Code linting (npm run lint - optional)
# 4. Semantic version bump based on session type
#
# The hook can be bypassed using: git commit --no-verify
#
# Exit codes:
# 0 - Success, commit proceeds
# 1 - Build failed
# 2 - Tests failed
# 3 - Version bump failed

# Redirect output to stderr for git hook convention
exec 1>&2

echo "ðŸ” Pre-commit validation starting..."

# Step 1: TypeScript compilation
echo "ðŸ”§ Step 1: TypeScript compilation..."
if ! npm run build; then
    echo "âŒ TypeScript compilation failed!"
    echo "   Fix compilation errors before committing."
    exit 1
fi
echo "âœ… TypeScript compilation successful"

# Step 2: Test suite execution
echo "ðŸ§ª Step 2: Running test suite..."
if ! npm run test:run; then
    echo "âŒ Tests failed!"
    echo "   All tests must pass before committing."
    exit 2
fi
echo "âœ… All tests passed"

# Step 3: Code linting (optional - doesn't block commit)
echo "ðŸŽ¨ Step 3: Code linting..."
if npm run lint 2>/dev/null; then
    echo "âœ… Linting passed"
else
    echo "âš ï¸  Linting issues detected (non-blocking)"
fi

# Step 4: Semantic version bump
echo "ðŸ”¢ Step 4: Version management..."

# Check if session type is defined
SESSION_TYPE_FILE=".session-type"
if [ -f "$SESSION_TYPE_FILE" ]; then
    SESSION_TYPE=$(cat "$SESSION_TYPE_FILE")
    echo "ðŸ“‹ Session type: $SESSION_TYPE"
else
    # Default to patch if no session type is specified
    SESSION_TYPE="patch"
    echo "ðŸ“‹ No session type specified, defaulting to: $SESSION_TYPE"
fi

# Validate session type
case "$SESSION_TYPE" in
    patch|minor|major)
        echo "ðŸš€ Performing $SESSION_TYPE version bump..."
        if ! npm version "$SESSION_TYPE" --no-git-tag-version; then
            echo "âŒ Version bump failed!"
            echo "   npm version $SESSION_TYPE command failed."
            exit 3
        fi
        NEW_VERSION=$(node -p "require('./package.json').version")
        echo "âœ… Version bumped to: $NEW_VERSION"
        
        # Step 5: Update CHANGELOG.md
        echo "ðŸ“ Step 5: Updating CHANGELOG.md..."
        # Extract commit message from environment or use generic message
        if [ -n "$COMMIT_MESSAGE" ]; then
            COMMIT_MSG="$COMMIT_MESSAGE"
        else
            # Generate message based on changes
            COMMIT_MSG="Automated $SESSION_TYPE version bump with validation enhancements"
        fi
        
        if ./scripts/update-changelog.sh "$NEW_VERSION" "$SESSION_TYPE" "$COMMIT_MSG"; then
            echo "âœ… CHANGELOG.md updated"
            # Stage the updated changelog
            git add CHANGELOG.md
        else
            echo "âš ï¸  CHANGELOG.md update failed (non-blocking)"
        fi
        
        # Stage the updated package.json and package-lock.json (version changes)
        git add package.json
        if [ -f "package-lock.json" ]; then
            git add package-lock.json
            echo "âœ… package-lock.json included in commit"
        fi
        ;;
    *)
        echo "âŒ Invalid session type: $SESSION_TYPE"
        echo "   Valid types: patch, minor, major"
        echo "   Set session type: echo 'patch' > .session-type"
        exit 3
        ;;
esac

echo "ðŸŽ‰ Pre-commit validation completed successfully!"
echo "ðŸ“¦ Ready to commit with version: $NEW_VERSION"

# Clean up session type file after successful commit
rm -f "$SESSION_TYPE_FILE"

exit 0